package com.example.arbitre;

import java.util.ArrayList;
import java.util.concurrent.ExecutionException;

import org.json.JSONException;

import com.example.arbitre.models.Connection;
import com.example.arbitre.models.Fichier;
import com.example.arbitre.models.Joueur;
import com.example.arbitre.models.Match;

import android.os.Bundle;
import android.app.Activity;
import android.app.Dialog;
import android.content.Context;
import android.content.Intent;
import android.util.Log;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Toast;

public class Jeu extends Activity {
	// TODO Ajouter verif si match fini
	// lors de l envoi des points
	// reception si match fini ou non
	// si c est le cas on retourne a mainactivity
	private ArrayList<Joueur> players;
	private int matchId;
	private int jeuId;
	private Context c;

	@SuppressWarnings("unchecked")
	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_jeu);
		
		Intent intent = getIntent();
		//int matchIdFile = -1;
		c = this;
		players = new ArrayList<Joueur>();
		players = (ArrayList<Joueur>) intent.getSerializableExtra("players");
		matchId = intent.getIntExtra("matchID",0);
		jeuId = -1;
		
		// TODO commentaire du fichier
		/*
		try {
			matchIdFile = Match.fromJSON(Fichier.lireFichier("arbitreDatas.txt",c)).getId();
			Log.e("matchIdFile", Integer.toString(matchIdFile));
		} catch (JSONException e) {
			e.printStackTrace();
		}
		
		if(matchIdFile != -1){
			matchId = matchIdFile;
		}*/
		
		//Toast.makeText(getApplicationContext(), "extra: "+json, Toast.LENGTH_LONG).show();
		
		// Traitement pour afficher le nom des joueurs
		Button btnJoueurPlay1 = (Button) findViewById(R.id.btnJoueurPlay1);
		Button btnJoueurPlay2 = (Button) findViewById(R.id.btnJoueurPlay2);
		//MenuItem pause = (MenuItem) findViewById(R.id.action_pause);
		
		btnJoueurPlay1.setText(players.get(0).getNom() + " - " + players.get(0).getPrenom() + "\n +1 point");
		btnJoueurPlay2.setText(players.get(1).getNom() + " - " + players.get(1).getPrenom() + "\n +1 point");
		
	}

	@Override
	public boolean onCreateOptionsMenu(Menu menu) {
		// Inflate the menu; this adds items to the action bar if it is present.
		getMenuInflater().inflate(R.menu.jeu, menu);
		return true;
	}
	
	public void btnJoueurPlay1OnClick(View v){
		AddPoints(0);
	}
	
	public void btnJoueurPlay2OnClick(View v){
		AddPoints(1);
	}
	
	@Override
	public boolean onOptionsItemSelected(MenuItem item) {
		switch (item.getItemId()){
		case R.id.action_pause:
			final Dialog dialog = new Dialog(this);
			dialog.setContentView(R.layout.popup_pause);
			dialog.setTitle("Pause");
			
			Button btnValiderPopUpPause = (Button) dialog.findViewById(R.id.btnValiderPopUpPause);
			Button btnAnnulerPopUp = (Button) dialog.findViewById(R.id.btnAnnulerPopUp);
			
			// if button is clicked, close the custom dialog
			btnValiderPopUpPause.setOnClickListener(new OnClickListener() {
				@Override
				public void onClick(View v) {
					// TODO commentaire enregistrement fichier

					EditText txtRaison = (EditText) dialog.findViewById(R.id.txtRaison);
					// enregistre matchId fichier
					String json = "{\"matchId\":\""+Integer.toString(matchId)+"\","+"\"raison\":\""+txtRaison.getText().toString()+"\"}";
					//Fichier.enregistrerDonnees(json, c);
					dialog.dismiss();		
				}
			});
			
			btnAnnulerPopUp.setOnClickListener(new OnClickListener() {
				@Override
				public void onClick(View v) {
					dialog.dismiss();
				}
			});
			
			dialog.show();
			return true;
		default:
			return super.onOptionsItemSelected(item);
		}	
	}
	
	private String envoyerDonner(String JSON, String url) {
		String rep="";
		if (Connection.isNetworkAvailable(this)) { // on verifie qu on a acces au web
            try { // oui on essaye de se connecter a l adresse
                rep = new Connection(JSON, "POST").execute(url).get();
                System.out.println("Reponse serveur (json): " + rep);    
            } catch (InterruptedException e) {
                System.out.println("InterruptedException: " + e);
                e.printStackTrace();
            } catch (ExecutionException e) {
                System.out.println("ExecutionException: " + e);
                e.printStackTrace();
            }
        } else {
            System.out.println("No network connection available.");
            Toast.makeText(this.getApplicationContext(),
                    "No network connection available.", Toast.LENGTH_SHORT)
                    .show();
        }
		return rep;
	}
	
	/**
	 * Envoi au server le json pour mettre a jour le score
	 * @param playerInt permet de savoir dans le tableau quel joueur marque le point
	 */
	private void AddPoints(int playerInt){
		String url = "http://82.237.169.116/rolandgarros/jeu.php";
		// TODO Modifier JSON
		String json = "{\"jeu\":[{\"jeuID\":\""+jeuId+"\",\"matchID\":\""+matchId+"\",\"joueur\":\""+players.get(playerInt).getId()+"\"}]}";
		//Toast.makeText(getApplicationContext(), json, Toast.LENGTH_SHORT).show();
		jeuId = Integer.parseInt(envoyerDonner(json, url));
		
		if(jeuId == -1){
			Toast.makeText(getApplicationContext(), "Match Fini", Toast.LENGTH_LONG).show();
			onDestroy();
		}
	}
}
